"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class t extends Error{message;col;code;static exp;constructor(t,o,e=exports.ErrorCode.SYNTAX){super(),this.col=t,this.code=e,this.message=`\n${this.toCodeLocTip()}\nCtxexpParserError(${e}): ${o}\n`}toCodeLocTip(){return`    ${t.exp}\n    ${" ".repeat(this.col)}^`}}var o,e;exports.ErrorCode=void 0,(o=exports.ErrorCode||(exports.ErrorCode={}))[o.SYNTAX=1]="SYNTAX",o[o.CALL=2]="CALL",o[o.READ=3]="READ",function(t){t.OPE_POI=".",t.OPE_ARG_SPT=",",t.OPE_ARR_OPEN="[",t.OPE_ARR_CLOSE="]",t.OPE_CALL_OPEN="(",t.OPE_CALL_CLOSE=")",t.OPE_ARG_OPEN="fn(",t.OPE_ARG_CLOSE="fn)",t.OPE_STR_OPEN="ope_str_open",t.OPE_STR_CLOSE="ope_str_close",t.ID_ARR="id_arr",t.ID_OBJ="id_obj",t.DEF_VAR="def_var",t.ID_FN="id_fn",t.DT_STR="dt_str",t.DT_NUM="dt_num",t.DT_FN="dt_fn",t.EOF="eof"}(e||(e={})),function(t){for(const o in t)Object.defineProperty(t,t[o],{value:o,enumerable:!1})}(e);class r{text;type;col;constructor(t,o,r=e[e[t]]??e.ID_OBJ){this.type=r,this.text=t,this.col=o}}const s={start:{on:{$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}}},def:()=>{}},O1:{on:{".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be '.', not '${e}'`)}},O2:{on:{isProperty:{to:"K1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be work, not '${e}'`)}},K1:{on:{isProperty:{to:"K1",do:(t,o)=>{t.str+=o}},".":{to:"O2",do:(t,o)=>{t.emit(),t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.emit(e.ID_FN),t.str=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.emit(),t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.emit(),t.str=o,t.emit()}},"[":{to:"O3",do:(t,o)=>{t.emit(),t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be '.' or '(' or '[', not '${e}'`)}},O3:{on:{isNumberData:{to:"N1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be int, not '${e}'`)}},N1:{on:{isNumberData:{to:"N1",do:(t,o)=>{t.str=o}},"]":{to:"O4",do:(t,o)=>{t.emit(e.ID_ARR),t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be int or ']', not '${e}'`)}},O4:{on:{".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}},isProperty:{to:"K1",do:(t,o)=>{t.str=o}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.str=o,t.emit()}},"[":{to:"O3",do:(t,o)=>{t.str=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be int or '.' or word or ',' or '(', not '${e}'`)}},O5:{on:{$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},'"':{to:"O8",do:(t,o)=>{t.str=o,t.emit(e.OPE_STR_OPEN)}},isNumberData:{to:"N2",do:(t,o)=>{t.str=o}},"(":{to:"F1",do:(t,o)=>{t.str=o,t.emit(e.OPE_ARG_OPEN)}},isProperty:{to:"K1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be int or '$' or ')' or callback or word or string open, not '${e}'`)}},F1:{on:{isProperty:{to:"K2",do:(t,o)=>{t.str=o}},")":{to:"F2",do:(t,o)=>{t.str=o,t.emit(e.OPE_ARG_CLOSE)}}}},K2:{on:{isProperty:{to:"K2",do:(t,o)=>{t.str+=o}},")":{to:"F2",do:(t,o)=>{t.emit(),t.str=o,t.emit(e.OPE_ARG_CLOSE)}},",":{to:"O10",do:(t,o)=>{t.emit(),t.str=o,t.emit()}}}},O10:{on:{isProperty:{to:"K2",do:(t,o)=>{t.str+=o}}}},F2:{on:{"=":{to:"F3",do:(t,o)=>{t.str+=o}}}},F3:{on:{">":{to:"F3",do:(t,o)=>{t.str+=o,t.emit(e.DT_FN)}},$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}},isProperty:{to:"K3",do:(t,o)=>{t.str=o,t.emit()}},'"':{to:"O8",do:(t,o)=>{t.str=o,t.emit(e.OPE_STR_OPEN)}},isNumberData:{to:"N2",do:(t,o)=>{t.str=o}}}},K3:{on:{isProperty:{to:"K3",do:(t,o)=>{t.str+=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.str=o,t.emit()}},".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}}}},N2:{on:{isNumberData:{to:"N2",do:(t,o)=>{t.str+=o}},")":{to:"O6",do:(t,o)=>{t.emit(e.DT_NUM),t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.emit(e.DT_NUM),t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be int or ',' or ')', not '${e}'`)}},O8:{on:{'"':{to:"O9",do:(t,o)=>{t.emit(e.DT_STR),t.str=o,t.emit(e.OPE_STR_CLOSE)}}},def:(t,o)=>'"'!==o?(t.str=o,"S1"):void 0},S1:{on:{"\\":"S2",'"':{to:"O9",do:(t,o)=>{t.emit(e.DT_STR),t.str=o,t.emit(e.OPE_STR_CLOSE)}}},def:(t,o)=>'"'!==o?(t.str+=o,"S1"):void 0},S2:{def:(t,o)=>(t.str+=o,"S1")},O9:{on:{")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be ')' or ',', not '${e}'`)}},O6:{on:{")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}},".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be ')' or ',' or '.', not '${e}'`)}},O7:{on:{$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}},'"':{to:"O8",do:(t,o)=>{t.str=o,t.emit(e.OPE_STR_OPEN)}},isNumberData:{to:"N2",do:(t,o)=>{t.str=o}},"(":{to:"F1",do:(t,o)=>{t.str=o,t.emit(e.OPE_ARG_OPEN)}},isProperty:{to:"K1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be '$' or '"' or int, not '${e}'`)}}},n=(t,o)=>"isProperty"===t?/\w/.test(o):"isNumberData"===t?(t=>/[\d\-\.\+]/.test(t))(o):t===o;class i{exp;constructor(o){t.exp=o,this.exp=o}toTokens(){return function(t){const o={str:"",idx:0,tokens:[],emit:t=>{o.str&&o.tokens.push(new r(o.str,o.str.length>1?o.idx-o.str.length:o.idx,t)),o.str=""}};let e="start";for(let r=0;r<t.length;r++){const i=t[r];o.idx=r;const d=s[e];let O=!1;if(d.on)for(const[t,r]of Object.entries(d.on))if(n(t,i)){O=!0,"string"==typeof r?e=r:(r.do?.(o,i),e=r.to);break}if(!O&&d.def){const t=d.def(o,i);t&&(e=t)}}return o.idx++,o.emit(),o.tokens}(this.exp)}}class d{col;name;prop;constructor(t,o=0,e=null){this.name=t,this.prop=e,this.col=o}}class O{col;name;args;prop;constructor(t,o=0,e=[],r=null){this.name=t,this.args=e,this.col=o,this.prop=r}}class _{col;value;constructor(t,o=0){this.value=t,this.col=o}}class p{tokens;ctx;exp;constructor(t,o){this.ctx=t,this.exp=o}toTokens(t=this.exp){return this.tokens=new i(t).toTokens()}toAst(o=this.tokens){const s=this;let n=null,i=null;c();let p=function p(){if(n?.type===e.ID_OBJ){const t=new d(n.text,n.col);let o=t;for(c();n?.type===e.OPE_POI||n?.type===e.OPE_ARR_OPEN||n?.type===e.OPE_ARR_CLOSE;)c(),i?.type!==e.OPE_ARR_CLOSE||n?.type!==e.OPE_POI&&n?.type!==e.OPE_ARR_OPEN||c(),n?.type===e.ID_OBJ||n?.type===e.ID_ARR?(o=o.prop=new d(n.text,n.col),c()):o=o.prop=p();return t}if(n?.type===e.ID_FN){const o=new O(n.text,n.col);if(c(),n?.type!==e.OPE_CALL_OPEN)throw new t(n.col,`method ${i.text} syntax error`,exports.ErrorCode.SYNTAX);for(c();n&&n.type!==e.OPE_CALL_CLOSE;){n?.type===e.OPE_ARG_SPT&&c();const t=p();if(o.args.push(t),n?.type===e.OPE_CALL_CLOSE)break;c()}return c(),n?.type===e.OPE_POI?(c(),o.prop=p()):n?.type===e.OPE_CALL_OPEN&&(o.prop=p()),o}if(n?.type===e.OPE_CALL_OPEN)return o.unshift(n),o.unshift(new r("__DEFAULT__",n.col,e.ID_FN)),c(),p();if(n?.type===e.OPE_STR_OPEN){c();const t=n?.type===e.OPE_ARR_CLOSE?new _("",n.col):new _(n.text,n.col);return c(),t}if(n?.type===e.DT_NUM)return new _(Number(n.text),n.col);if(n?.type===e.OPE_ARG_OPEN){const t=[],o=n.col;for(c();n?.type!==e.OPE_ARG_CLOSE;)n?.type===e.OPE_ARG_SPT&&c(),t.push(n),c();c(),c();const r=p();return new _((...o)=>s.execAst(r,s.ctx,function(t,o){const e={};for(let r=0;r<o.length;r++){e[o[r].text]=t[r]}return e}(o,t)),o)}return null}();return p;function c(){i=n,n=o.shift()}}execAst(o,e=this.ctx,r={}){const s=(o,n)=>{if(!o||0===Object.keys(o).length)return n;if(o instanceof O){const r=[];for(let t=0;t<o.args.length;t++){const n=o.args[t],i=s(n,e);r.push(i)}let i=null;if("__DEFAULT__"===o.name){if("function"!=typeof n)throw new t(o.col,"It's not a method",exports.ErrorCode.CALL);i=n(...r)}else{if(void 0===n||"function"!=typeof n[o.name])throw new t(o.col,`No method exists ${o.name}`,exports.ErrorCode.CALL);i=n[o.name](...r)}return s(o.prop,i)}if(o instanceof d){if("$"===o.name){return s(o.prop,e)}return s(o.prop,r?.[o.name]??n?.[o.name])}return o instanceof _?o.value:void 0};return s(o,e)}exec(t=this.exp){return this.toTokens(t),this.execAst(this.toAst(),this.ctx)}}exports.CtxexpParser=p,exports.Exception=t,exports.default=p;
