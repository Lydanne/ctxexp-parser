// Copyright (c) 2021 WumaCoder
// 
// This software is released under the MIT License.
// https://opensource.org/licenses/MIT

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Exception extends Error{message;col;code;static exp;constructor(e,t,n=exports.ErrorCode.SYNTAX){super(),this.col=e,this.code=n,this.message=`\n${this.toCodeLocTip()}\nCtxexpParserError(${n}): ${t}\n`}toCodeLocTip(){return`    ${Exception.exp}\n    ${" ".repeat(this.col)}^`}}function mapperEnum(e){for(const t in e)Object.defineProperty(e,e[t],{value:t,enumerable:!1})}var TokenType;exports.ErrorCode=void 0,function(e){e[e.SYNTAX=1]="SYNTAX",e[e.CALL=2]="CALL",e[e.READ=3]="READ"}(exports.ErrorCode||(exports.ErrorCode={})),function(e){e.OPE_POI=".",e.OPE_ARG_SPT=",",e.OPE_ARR_OPEN="[",e.OPE_ARR_CLOSE="]",e.OPE_CALL_OPEN="(",e.OPE_CALL_CLOSE=")",e.OPE_ARG_OPEN="fn(",e.OPE_ARG_CLOSE="fn)",e.OPE_STR_OPEN="ope_str_open",e.OPE_STR_CLOSE="ope_str_close",e.ID_ARR="id_arr",e.ID_OBJ="id_obj",e.DEF_VAR="def_var",e.ID_FN="id_fn",e.DT_STR="dt_str",e.DT_NUM="dt_num",e.DT_FN="dt_fn",e.EOF="eof"}(TokenType=TokenType||{}),mapperEnum(TokenType);class Token{text;type;col;constructor(e,t,n=TokenType[TokenType[e]]??TokenType.ID_OBJ){this.type=n,this.text=e,this.col=t}}const isProperty=e=>/\w/.test(e),isNumberData=e=>/[\d\-\.\+]/.test(e);function createStater(t){let n="",o=0;const r=[];let i=function e(t){if("$"===t)return n=t,L(),s;return e};for(let e=0;e<t.length;e++){var p=t[e];o=e,i=i(p)}return o++,L(),r;function s(e){if("."===e)return n=e,L(),u;throw new Exception(o,`must be '.', not '${e}'`)}function u(e){if(isProperty(e))return n=e,c;throw new Exception(o,`must be work, not '${e}'`)}function c(e){if(isProperty(e))return n+=e,c;if("."===e)return L(),n=e,L(),u;if("("===e)return L(TokenType.ID_FN),n=e,L(),E;if(")"===e)return L(),n=e,L(),R;if(","===e)return L(),n=e,L(),w;if("["===e)return L(),n=e,L(),T;throw new Exception(o,`must be '.' or '(' or '[', not '${e}'`)}function T(e){if(isNumberData(e))return n=e,_;throw new Exception(o,`must be int, not '${e}'`)}function _(e){if(isNumberData(e))return n=e,_;if("]"===e)return L(TokenType.ID_ARR),n=e,L(),f;throw new Exception(o,`must be int or ']', not '${e}'`)}function f(e){if("."===e)return n=e,L(),u;if(isProperty(e))return n=e,c;if(","===e)return n=e,L(),w;if("("===e)return n=e,L(),E;if("["===e)return n=e,L(),T;throw new Exception(o,`must be int or '.' or word or ',' or '(', not '${e}'`)}function E(e){if("$"===e)return n=e,L(),s;if(")"===e)return n=e,L(),R;if('"'===e)return n=e,L(TokenType.OPE_STR_OPEN),h;if(isNumberData(e))return n=e,k;if("("===e)return n=e,L(TokenType.OPE_ARG_OPEN),y;if(isProperty(e))return n=e,c;throw new Exception(o,`must be int or '$' or ')' or callback or word or string open, not '${e}'`)}function y(e){return isProperty(e)?(n=e,a):")"===e?(n=e,L(TokenType.OPE_ARG_CLOSE),P):void 0}function a(e){return isProperty(e)?(n+=e,a):")"===e?(L(),n=e,L(TokenType.OPE_ARG_CLOSE),P):","===e?(L(),n=e,L(),O):void 0}function O(e){if(isProperty(e))return n+=e,a}function P(e){if("="===e)return n+=e,l}function l(e){return">"===e?(n+=e,L(TokenType.DT_FN),l):"$"===e?(n=e,L(),s):isProperty(e)?(n=e,L(),x):'"'===e?(n=e,L(TokenType.OPE_STR_OPEN),h):isNumberData(e)?(n=e,k):void 0}function x(e){return isProperty(e)?(n+=e,L(),x):")"===e?(n=e,L(),R):","===e?(n=e,L(),w):"("===e?(n=e,L(),E):"."===e?(n=e,L(),u):void 0}function k(e){if(isNumberData(e))return n+=e,k;if(")"===e)return L(TokenType.DT_NUM),n=e,L(),R;if(","===e)return L(TokenType.DT_NUM),n=e,L(),w;throw new Exception(o,`must be int or ',' or ')', not '${e}'`)}function h(e){return'"'!==e?(n=e,N):'"'===e?(L(TokenType.DT_STR),n=e,L(TokenType.OPE_STR_CLOSE),A):void 0}function N(e){return"\\"===e?d:'"'!==e?(n+=e,N):'"'===e?(L(TokenType.DT_STR),n=e,L(TokenType.OPE_STR_CLOSE),A):void 0}function d(e){return n+=e,N}function A(e){if(")"===e)return n=e,L(),R;if(","===e)return n=e,L(),w;throw new Exception(o,`must be ')' or ',', not '${e}'`)}function R(e){if(")"===e)return n=e,L(),R;if(","===e)return n=e,L(),w;if("."===e)return n=e,L(),u;if("("===e)return n=e,L(),E;throw new Exception(o,`must be ')' or ',' or '.', not '${e}'`)}function w(e){if("$"===e)return n=e,L(),s;if('"'===e)return n=e,L(TokenType.OPE_STR_OPEN),h;if(isNumberData(e))return n=e,k;if("("===e)return n=e,L(TokenType.OPE_ARG_OPEN),y;if(isProperty(e))return n=e,c;throw new Exception(o,`must be '$' or '"' or int, not '${e}'`)}function L(e){n&&r.push(new Token(n,1<n.length?o-n.length:o,e)),n=""}}class Lexer{exp;constructor(e){Exception.exp=e,this.exp=e}toTokens(){return createStater(this.exp)}}class AccessNode{col;name;prop;constructor(e,t=0,n=null){this.name=e,this.prop=n,this.col=t}}class CallNode{col;name;args;prop;constructor(e,t=0,n=[],o=null){this.name=e,this.args=n,this.col=t,this.prop=o}}class DataNode{col;value;constructor(e,t=0){this.value=e,this.col=t}}class CtxexpParser{tokens;ctx;constructor(e,t){this.tokens=new Lexer(t).toTokens(),this.ctx=e}execAst(e,i=this.ctx,p={}){const s=(t,n)=>{if(!t||0===Object.keys(t).length)return n;if(t instanceof CallNode){const r=[];for(let e=0;e<t.args.length;e++){var o=t.args[e],o=s(o,i);r.push(o)}let e=null;if("__DEFAULT__"===t.name){if("function"!=typeof n)throw new Exception(t.col,"It's not a method",exports.ErrorCode.CALL);e=n(...r)}else{if(void 0===n||"function"!=typeof n[t.name])throw new Exception(t.col,`No method exists ${t.name}`,exports.ErrorCode.CALL);e=n[t.name](...r)}return s(t.prop,e)}return t instanceof AccessNode?"$"===t.name?s(t.prop,i):s(t.prop,p?.[t.name]??n?.[t.name]):t instanceof DataNode?t.value:void 0};return s(e,i)}exec(){return this.execAst(this.toAst(),this.ctx)}toAst(){const u=this,c=this.tokens;let T=null,_=null,e=0;return f(),function t(){if(T?.type===TokenType.ID_OBJ){const n=new AccessNode(T.text,T.col);let e=n;for(f();T?.type===TokenType.OPE_POI||T?.type===TokenType.OPE_ARR_OPEN||T?.type===TokenType.OPE_ARR_CLOSE;)f(),_?.type!==TokenType.OPE_ARR_CLOSE||T?.type!==TokenType.OPE_POI&&T?.type!==TokenType.OPE_ARR_OPEN||f(),T?.type===TokenType.ID_OBJ||T?.type===TokenType.ID_ARR?(e=e.prop=new AccessNode(T.text,T.col),f()):e=e.prop=t();return n}if(T?.type===TokenType.ID_FN){const e=new CallNode(T.text,T.col);if(f(),T?.type!==TokenType.OPE_CALL_OPEN)throw new Exception(T.col,`method ${_.text} syntax error`,exports.ErrorCode.SYNTAX);for(f();T&&T.type!==TokenType.OPE_CALL_CLOSE;){T?.type===TokenType.OPE_ARG_SPT&&f();const o=t();if(e.args.push(o),T?.type===TokenType.OPE_CALL_CLOSE)break;f()}return f(),T?.type===TokenType.OPE_POI?(f(),e.prop=t()):T?.type===TokenType.OPE_CALL_OPEN&&(e.prop=t()),e}if(T?.type===TokenType.OPE_CALL_OPEN)return c.unshift(T),c.unshift(new Token("__DEFAULT__",T.col,TokenType.ID_FN)),f(),t();if(T?.type===TokenType.OPE_STR_OPEN){f();const r=T?.type===TokenType.OPE_ARR_CLOSE?new DataNode("",T.col):new DataNode(T.text,T.col);return f(),r}if(T?.type===TokenType.DT_NUM)return new DataNode(Number(T.text),T.col);if(T?.type===TokenType.OPE_ARG_OPEN){const i=[],p=T.col;for(f();T?.type!==TokenType.OPE_ARG_CLOSE;)T?.type===TokenType.OPE_ARG_SPT&&f(),i.push(T),f();f(),f();const s=t();return new DataNode((...e)=>u.execAst(s,u.ctx,E(e,i)),p)}return null}();function f(){_=T,T=c.shift(),"("!==T?.text&&")"!==T?.text||(e+="("===T.text?1:-1)}function E(t,n){const o={};for(let e=0;e<n.length;e++){var r=n[e];o[r.text]=t[e]}return o}}}exports.Exception=Exception,exports.default=CtxexpParser;
