// Copyright (c) 2021 WumaCoder
// 
// This software is released under the MIT License.
// https://opensource.org/licenses/MIT

class Exception extends Error{message;col;code;static exp;constructor(e,t,n=ErrorCode.SYNTAX){super(),this.col=e,this.code=n,this.message=`\n${this.toCodeLocTip()}\nCtxexpParserError(${n}): ${t}\n`}toCodeLocTip(){return`    ${Exception.exp}\n    ${" ".repeat(this.col)}^`}}var ErrorCode,TokenType;function mapperEnum(e){for(const t in e)Object.defineProperty(e,e[t],{value:t,enumerable:!1})}!function(e){e[e.SYNTAX=1]="SYNTAX",e[e.CALL=2]="CALL",e[e.READ=3]="READ"}(ErrorCode=ErrorCode||{}),function(e){e.OPE_POI=".",e.OPE_ARG_SPT=",",e.OPE_ARR_OPEN="[",e.OPE_ARR_CLOSE="]",e.OPE_CALL_OPEN="(",e.OPE_CALL_CLOSE=")",e.OPE_STR_OPEN="ope_str_open",e.OPE_STR_CLOSE="ope_str_close",e.ID_ARR="id_arr",e.ID_OBJ="id_obj",e.ID_FN="id_fn",e.DT_STR="dt_str",e.DT_NUM="dt_num",e.EOF="eof"}(TokenType=TokenType||{}),mapperEnum(TokenType);class Token{text;type;col;constructor(e,t,n=TokenType[TokenType[e]]??TokenType.ID_OBJ){this.type=n,this.text=e,this.col=t}}const isProperty=e=>/\w/.test(e),isNumberData=e=>/[\d\-\.\+]/.test(e);function createStater(t){let n="",o=0;const r=[];let i=function e(t){if("$"===t)return n=t,N(),u;return e};for(let e=0;e<t.length;e++){var s=t[e];o=e,i=i(s)}return o++,N(),r;function u(e){if("."===e)return n=e,N(),c;throw new Exception(o,`must be '.', not '${e}'`)}function c(e){if(isProperty(e))return n=e,p;throw new Exception(o,`must be work, not '${e}'`)}function p(e){if(isProperty(e))return n+=e,p;if("."===e)return N(),n=e,N(),c;if("("===e)return N(TokenType.ID_FN),n=e,N(),E;if(")"===e)return N(),n=e,N(),O;if(","===e)return N(),n=e,N(),d;if("["===e)return N(),n=e,N(),T;throw new Exception(o,`must be '.' or '(' or '[', not '${e}'`)}function T(e){if(isNumberData(e))return n=e,f;throw new Exception(o,`must be int, not '${e}'`)}function f(e){if(isNumberData(e))return n=e,f;if("]"===e)return N(TokenType.ID_ARR),n=e,N(),_;throw new Exception(o,`must be int or ']', not '${e}'`)}function _(e){if("."===e)return n=e,N(),c;if(isProperty(e))return n=e,p;if(","===e)return n=e,N(),d;if("("===e)return n=e,N(),E;if("["===e)return n=e,N(),T;throw new Exception(o,`must be int or '.' or word or ',' or '(', not '${e}'`)}function E(e){if("$"===e)return n=e,N(),u;if(")"===e)return n=e,N(),O;if('"'===e)return n=e,N(TokenType.OPE_STR_OPEN),l;if(isNumberData(e))return n=e,a;throw new Exception(o,`must be int or '$' or ')' or word or string open, not '${e}'`)}function a(e){if(isNumberData(e))return n+=e,a;if(")"===e)return N(TokenType.DT_NUM),n=e,N(),O;if(","===e)return N(TokenType.DT_NUM),n=e,N(),d;throw new Exception(o,`must be int or ',' or ')', not '${e}'`)}function l(e){return'"'!==e?(n=e,y):'"'===e?(N(TokenType.DT_STR),n=e,N(TokenType.OPE_STR_CLOSE),x):void 0}function y(e){return"\\"===e?h:'"'!==e?(n+=e,y):'"'===e?(N(TokenType.DT_STR),n=e,N(TokenType.OPE_STR_CLOSE),x):void 0}function h(e){return n+=e,y}function x(e){if(")"===e)return n=e,N(),O;if(","===e)return n=e,N(),d;throw new Exception(o,`must be ')' or ',', not '${e}'`)}function O(e){if(")"===e)return n=e,N(),O;if(","===e)return n=e,N(),d;if("."===e)return n=e,N(),c;if("("===e)return n=e,N(),E;throw new Exception(o,`must be ')' or ',' or '.', not '${e}'`)}function d(e){if("$"===e)return n=e,N(),u;if('"'===e)return n=e,N(TokenType.OPE_STR_OPEN),l;if(isNumberData(e))return n=e,a;throw new Exception(o,`must be '$' or '"' or int, not '${e}'`)}function N(e){n&&r.push(new Token(n,1<n.length?o-n.length:o,e)),n=""}}class Lexer{exp;constructor(e){Exception.exp=e,this.exp=e}toTokens(){return createStater(this.exp)}}class AccessNode{col;name;prop;constructor(e,t=0,n=null){this.name=e,this.prop=n,this.col=t}}class CallNode{col;name;args;prop;constructor(e,t=0,n=[],o=null){this.name=e,this.args=n,this.col=t,this.prop=o}}class DataNode{col;value;constructor(e,t=0){this.value=e,this.col=t}}class CtxexpParser{tokens;ctx;constructor(e,t){this.tokens=new Lexer(t).toTokens(),this.ctx=e}execAst(e){const i=this.ctx,s=(t,n)=>{if(!t||0===Object.keys(t).length)return n;if(t instanceof CallNode){const r=[];for(let e=0;e<t.args.length;e++){var o=t.args[e],o=s(o,i);r.push(o)}let e=null;if("__DEFAULT__"===t.name){if("function"!=typeof n)throw new Exception(t.col,"It's not a method",ErrorCode.CALL);e=n(...r)}else{if(void 0===n||"function"!=typeof n[t.name])throw new Exception(t.col,`No method exists ${t.name}`,ErrorCode.CALL);e=n[t.name](...r)}return s(t.prop,e)}if(t instanceof AccessNode){if("$"===t.name)return s(t.prop,i);if(void 0===n)throw new Exception(t.col,"ctx not undefined",ErrorCode.READ);return s(t.prop,n[t.name])}return t instanceof DataNode?t.value:void 0};return s(e,i)}exec(){return this.execAst(this.toAst())}toAst(){const e=this.tokens;let n=null,o=null;return function e(){r();if(!n)return null;if(n.type===TokenType.OPE_ARG_SPT)return null;if(n.type===TokenType.ID_OBJ&&null===o)return new AccessNode(n.text,n.col,e());if(n.type===TokenType.ID_OBJ&&o.type===TokenType.OPE_POI)return new AccessNode(n.text,n.col,e());if(n.type===TokenType.ID_ARR)return new AccessNode(n.text,n.col,e());if(n.type===TokenType.ID_FN&&o.type===TokenType.OPE_POI)return new CallNode(n.text,n.col,e(),e());if(n.type===TokenType.OPE_CALL_OPEN&&o.type===TokenType.OPE_CALL_CLOSE)return new CallNode("__DEFAULT__",n.col,e(),e());if(n.type===TokenType.OPE_CALL_OPEN&&o.type===TokenType.OPE_ARR_CLOSE)return new CallNode("__DEFAULT__",n.col,e(),e());if(o.type===TokenType.OPE_CALL_OPEN){const t=[];if(n.type===TokenType.OPE_CALL_CLOSE)return t;for(n.type===TokenType.DT_NUM?(t.push(new DataNode(Number(n.text),n.col)),r()):n.type===TokenType.OPE_STR_OPEN?(r(),t.push(new DataNode(String(n.text),n.col)),r(),r()):t.push(new AccessNode(n.text,n.col,e())),r();o?.type===TokenType.OPE_ARG_SPT;)n.type===TokenType.DT_NUM?(t.push(new DataNode(Number(n.text),n.col)),r()):n.type===TokenType.OPE_STR_OPEN?(r(),t.push(new DataNode(String(n.text),n.col)),r(),r()):t.push(new AccessNode(n.text,n.col,e())),r();return t}return e()}();function r(){o=n,n=e.shift()}}}export{ErrorCode,Exception,CtxexpParser as default};
