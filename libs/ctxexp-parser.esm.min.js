class t extends Error{message;col;code;static exp;constructor(t,e,r=o.SYNTAX){super(),this.col=t,this.code=r,this.message=`\n${this.toCodeLocTip()}\nCtxexpParserError(${r}): ${e}\n`}toCodeLocTip(){return`    ${t.exp}\n    ${" ".repeat(this.col)}^`}}var o,e;!function(t){t[t.SYNTAX=1]="SYNTAX",t[t.CALL=2]="CALL",t[t.READ=3]="READ"}(o||(o={})),function(t){t.OPE_POI=".",t.OPE_ARG_SPT=",",t.OPE_ARR_OPEN="[",t.OPE_ARR_CLOSE="]",t.OPE_CALL_OPEN="(",t.OPE_CALL_CLOSE=")",t.OPE_ARG_OPEN="fn(",t.OPE_ARG_CLOSE="fn)",t.OPE_STR_OPEN="ope_str_open",t.OPE_STR_CLOSE="ope_str_close",t.ID_ARR="id_arr",t.ID_OBJ="id_obj",t.DEF_VAR="def_var",t.ID_FN="id_fn",t.DT_STR="dt_str",t.DT_NUM="dt_num",t.DT_FN="dt_fn",t.EOF="eof"}(e||(e={})),function(t){for(const o in t)Object.defineProperty(t,t[o],{value:o,enumerable:!1})}(e);class r{text;type;col;constructor(t,o,r=e[e[t]]??e.ID_OBJ){this.type=r,this.text=t,this.col=o}}const s={start:{on:{$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}}},def:()=>{}},O1:{on:{".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be '.', not '${e}'`)}},O2:{on:{isProperty:{to:"K1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be work, not '${e}'`)}},K1:{on:{isProperty:{to:"K1",do:(t,o)=>{t.str+=o}},".":{to:"O2",do:(t,o)=>{t.emit(),t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.emit(e.ID_FN),t.str=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.emit(),t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.emit(),t.str=o,t.emit()}},"[":{to:"O3",do:(t,o)=>{t.emit(),t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be '.' or '(' or '[', not '${e}'`)}},O3:{on:{isNumberData:{to:"N1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be int, not '${e}'`)}},N1:{on:{isNumberData:{to:"N1",do:(t,o)=>{t.str=o}},"]":{to:"O4",do:(t,o)=>{t.emit(e.ID_ARR),t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be int or ']', not '${e}'`)}},O4:{on:{".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}},isProperty:{to:"K1",do:(t,o)=>{t.str=o}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.str=o,t.emit()}},"[":{to:"O3",do:(t,o)=>{t.str=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be int or '.' or word or ',' or '(', not '${e}'`)}},O5:{on:{$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},'"':{to:"O8",do:(t,o)=>{t.str=o,t.emit(e.OPE_STR_OPEN)}},isNumberData:{to:"N2",do:(t,o)=>{t.str=o}},"(":{to:"F1",do:(t,o)=>{t.str=o,t.emit(e.OPE_ARG_OPEN)}},isProperty:{to:"K1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be int or '$' or ')' or callback or word or string open, not '${e}'`)}},F1:{on:{isProperty:{to:"K2",do:(t,o)=>{t.str=o}},")":{to:"F2",do:(t,o)=>{t.str=o,t.emit(e.OPE_ARG_CLOSE)}}}},K2:{on:{isProperty:{to:"K2",do:(t,o)=>{t.str+=o}},")":{to:"F2",do:(t,o)=>{t.emit(),t.str=o,t.emit(e.OPE_ARG_CLOSE)}},",":{to:"O10",do:(t,o)=>{t.emit(),t.str=o,t.emit()}}}},O10:{on:{isProperty:{to:"K2",do:(t,o)=>{t.str+=o}}}},F2:{on:{"=":{to:"F3",do:(t,o)=>{t.str+=o}}}},F3:{on:{">":{to:"F3",do:(t,o)=>{t.str+=o,t.emit(e.DT_FN)}},$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}},isProperty:{to:"K3",do:(t,o)=>{t.str=o,t.emit()}},'"':{to:"O8",do:(t,o)=>{t.str=o,t.emit(e.OPE_STR_OPEN)}},isNumberData:{to:"N2",do:(t,o)=>{t.str=o}}}},K3:{on:{isProperty:{to:"K3",do:(t,o)=>{t.str+=o,t.emit()}},")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.str=o,t.emit()}},".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}}}},N2:{on:{isNumberData:{to:"N2",do:(t,o)=>{t.str+=o}},")":{to:"O6",do:(t,o)=>{t.emit(e.DT_NUM),t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.emit(e.DT_NUM),t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be int or ',' or ')', not '${e}'`)}},O8:{on:{'"':{to:"O9",do:(t,o)=>{t.emit(e.DT_STR),t.str=o,t.emit(e.OPE_STR_CLOSE)}}},def:(t,o)=>'"'!==o?(t.str=o,"S1"):void 0},S1:{on:{"\\":"S2",'"':{to:"O9",do:(t,o)=>{t.emit(e.DT_STR),t.str=o,t.emit(e.OPE_STR_CLOSE)}}},def:(t,o)=>'"'!==o?(t.str+=o,"S1"):void 0},S2:{def:(t,o)=>(t.str+=o,"S1")},O9:{on:{")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be ')' or ',', not '${e}'`)}},O6:{on:{")":{to:"O6",do:(t,o)=>{t.str=o,t.emit()}},",":{to:"O7",do:(t,o)=>{t.str=o,t.emit()}},".":{to:"O2",do:(t,o)=>{t.str=o,t.emit()}},"(":{to:"O5",do:(t,o)=>{t.str=o,t.emit()}}},def:(o,e)=>{throw new t(o.idx,`must be ')' or ',' or '.', not '${e}'`)}},O7:{on:{$:{to:"O1",do:(t,o)=>{t.str=o,t.emit()}},'"':{to:"O8",do:(t,o)=>{t.str=o,t.emit(e.OPE_STR_OPEN)}},isNumberData:{to:"N2",do:(t,o)=>{t.str=o}},"(":{to:"F1",do:(t,o)=>{t.str=o,t.emit(e.OPE_ARG_OPEN)}},isProperty:{to:"K1",do:(t,o)=>{t.str=o}}},def:(o,e)=>{throw new t(o.idx,`must be '$' or '"' or int, not '${e}'`)}}},n=(t,o)=>"isProperty"===t?/\w/.test(o):"isNumberData"===t?(t=>/[\d\-\.\+]/.test(t))(o):t===o;class i{exp;constructor(o){t.exp=o,this.exp=o}toTokens(){return function(t){const o={str:"",idx:0,tokens:[],emit:t=>{o.str&&o.tokens.push(new r(o.str,o.str.length>1?o.idx-o.str.length:o.idx,t)),o.str=""}};let e="start";for(let r=0;r<t.length;r++){const i=t[r];o.idx=r;const O=s[e];let d=!1;if(O.on)for(const[t,r]of Object.entries(O.on))if(n(t,i)){d=!0,"string"==typeof r?e=r:(r.do?.(o,i),e=r.to);break}if(!d&&O.def){const t=O.def(o,i);t&&(e=t)}}return o.idx++,o.emit(),o.tokens}(this.exp)}}class O{col;name;prop;constructor(t,o=0,e=null){this.name=t,this.prop=e,this.col=o}}class d{col;name;args;prop;constructor(t,o=0,e=[],r=null){this.name=t,this.args=e,this.col=o,this.prop=r}}class _{col;value;constructor(t,o=0){this.value=t,this.col=o}}class c{tokens;ctx;exp;constructor(t,o){this.ctx=t,this.exp=o}toTokens(t=this.exp){return this.tokens=new i(t).toTokens()}toAst(s=this.tokens){const n=this;let i=null,c=null;p();let m=function m(){if(i?.type===e.ID_OBJ){const t=new O(i.text,i.col);let o=t;for(p();i?.type===e.OPE_POI||i?.type===e.OPE_ARR_OPEN||i?.type===e.OPE_ARR_CLOSE;)p(),c?.type!==e.OPE_ARR_CLOSE||i?.type!==e.OPE_POI&&i?.type!==e.OPE_ARR_OPEN||p(),i?.type===e.ID_OBJ||i?.type===e.ID_ARR?(o=o.prop=new O(i.text,i.col),p()):o=o.prop=m();return t}if(i?.type===e.ID_FN){const r=new d(i.text,i.col);if(p(),i?.type!==e.OPE_CALL_OPEN)throw new t(i.col,`method ${c.text} syntax error`,o.SYNTAX);for(p();i&&i.type!==e.OPE_CALL_CLOSE;){i?.type===e.OPE_ARG_SPT&&p();const t=m();if(r.args.push(t),i?.type===e.OPE_CALL_CLOSE)break;p()}return p(),i?.type===e.OPE_POI?(p(),r.prop=m()):i?.type===e.OPE_CALL_OPEN&&(r.prop=m()),r}if(i?.type===e.OPE_CALL_OPEN)return s.unshift(i),s.unshift(new r("__DEFAULT__",i.col,e.ID_FN)),p(),m();if(i?.type===e.OPE_STR_OPEN){p();const t=i?.type===e.OPE_ARR_CLOSE?new _("",i.col):new _(i.text,i.col);return p(),t}if(i?.type===e.DT_NUM)return new _(Number(i.text),i.col);if(i?.type===e.OPE_ARG_OPEN){const t=[],o=i.col;for(p();i?.type!==e.OPE_ARG_CLOSE;)i?.type===e.OPE_ARG_SPT&&p(),t.push(i),p();p(),p();const r=m();return new _((...o)=>n.execAst(r,n.ctx,function(t,o){const e={};for(let r=0;r<o.length;r++){e[o[r].text]=t[r]}return e}(o,t)),o)}return null}();return m;function p(){c=i,i=s.shift()}}execAst(e,r=this.ctx,s={}){const n=(e,i)=>{if(!e||0===Object.keys(e).length)return i;if(e instanceof d){const s=[];for(let t=0;t<e.args.length;t++){const o=e.args[t],i=n(o,r);s.push(i)}let O=null;if("__DEFAULT__"===e.name){if("function"!=typeof i)throw new t(e.col,"It's not a method",o.CALL);O=i(...s)}else{if(void 0===i||"function"!=typeof i[e.name])throw new t(e.col,`No method exists ${e.name}`,o.CALL);O=i[e.name](...s)}return n(e.prop,O)}if(e instanceof O){if("$"===e.name){return n(e.prop,r)}return n(e.prop,s?.[e.name]??i?.[e.name])}return e instanceof _?e.value:void 0};return n(e,r)}exec(t=this.exp){return this.toTokens(t),this.execAst(this.toAst(),this.ctx)}}export{c as CtxexpParser,o as ErrorCode,t as Exception,c as default};
